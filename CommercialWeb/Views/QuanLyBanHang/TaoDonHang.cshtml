@using CommercialWeb.Models
@model IEnumerable<ItemDonHang>
@{
    ViewBag.Title = "TaoDonHang";
    Layout = "~/Views/Layout/AdminLayout.cshtml";
}

<p class="home"><a href="@Url.Action("ChuaGiao", "QuanLyDonhang")">Trang chủ</a> > <strong> Tạo đơn hàng mới</strong></p>
<br />
<h1 style="font-weight:bold; margin:5px; text-align:center">TẠO ĐƠN HÀNG MỚI</h1>
<br />
<div class="ctdh-block">
    <h3 style="font-weight:bold; background-color:#27ae60; padding:5px; color:#ffffff">Chi tiết đơn hàng</h3>
    <div class="form-inline" style="margin-top:20px; margin-bottom:20px">
        @*<input data-live-search="true" type="text" id="product-name" placeholder="Nhập tên sản phẩm" class="search-box" />*@
        <select class="selectpicker" data-live-search="true" id="mySearch"></select>
        <input type="number" placeholder="1" class="form-control" min="1" value="1" id="product-number"/>
        <a class="btn btn-info" id="btn-add-product" href="#">Thêm sản phẩm</a>
    </div>
    <table class="gridTable table-hover" >
        <thead style="color:#ffffff;font-weight:bold">
            <tr>
                <th class="gridHead">Mã SP</th>
                <th class="gridHead">Tên SP</th>
                <th class="gridHead">Số lượng</th>
                <th class="gridHead">Bảo hành</th>
                <th class="gridHead">Đơn giá</th>
                <th class="gridHead">Khuyến mãi</th>
                <th class="gridHead">Giá bán</th>
                <th class="gridHead">Tác vụ</th>
            </tr>
        </thead>
        <tbody class="gridRow" id="row_holder">
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.MaSP</td>
                    <td>@item.TenSP</td>
                    <td>@item.SoLuong</td>
                    <td>@item.ThoiHanBaoHanh</td>
                    <td>@item.DonGia</td>
                    <td data-toggle='tooltip' data-placement='right' title='"@item.TenKhuyenMai"'>@item.MoTa %</td>
                    <td>@item.GiaBan</td>
                    @*<td><a class='btn btn-info' href='#'>Xóa</a></td>*@
                    <td>@Html.ActionLink("Xóa", "XoaItemDonHang", new { @MaSP = item.MaSP }, new { @class = "btn btn-info" })</td>
                </tr>
            }
        </tbody>
    </table>
    <label><input type="checkbox" id="check-box-tt" checked="checked"/>Đã thanh toán</label>
    <label><input type="checkbox" id="check-box-gh" checked="checked"/>Đã giao</label>
</div>
<div class="tong-tien"></div>
<div class="ttkh-block">
    <h3 style="font-weight:bold; background-color:#27ae60; padding:5px; color:#ffffff">Thông tin khách hàng</h3>
    <h5>Khách hàng thành viên</h5>
    <div class="form-inline" style="margin-top:20px; margin-bottom:20px">
        <select class="selectpicker" data-live-search="true" id="mySearch2"></select>
        <a class="btn btn-info" id="btn-add-1" href="#">Tạo đơn hàng</a>
    </div>
    <h5>Khách hàng thường</h5><br />
    <div class="form-kh">
        <div class="form-group">
            <label for="HoTen">Họ và tên</label>
            <input type="text" class="form-control" placeholder="Nhập họ tên" />
        </div>
        <div class="form-group">
            <label for="Email">Email</label>
            <input type="email" class="form-control" placeholder="Nhập email" />
        </div>
        <div class="form-group">
            <label for="SDT">Số điện thoại</label>
            <input type="text" class="form-control" maxlength="12" placeholder="Nhập số điện thoại" />
        </div>
        <div class="form-group">
            <label for="DiaChi">Địa chỉ</label>
            <input type="text" class="form-control" placeholder="Nhập địa chỉ" />
        </div> 
    </div>
    <a class="btn btn-info" id="btn-add-2" href="#" style="float:right">Tạo đơn hàng</a>
    
</div>

<style type="text/css">
    .ctdh-block{
        width:100%;
    }
    .search-block{
        width:100%;
        height:20%;
        background-color:none;
        padding: 10px;
        display: inline-block;
    }
    .search-box{
        width:40%;
        margin-right:10px;
    }
    #check-box{
        margin-right:10px;
    }
    .form-control{
        width:10%;
        margin-right:10px;
    }
    .ttkh-block{
        margin-top:10px;
    }
    h5{
        font-weight:bold;
        margin-top:20px;
        margin-bottom:10px;
    }
    .form-control{
        width:100%
    }
    
</style>

<script type="text/javascript">
    $(document).ready(function () {
        $.ajax({
            type: "POST",
            dataType: 'json',
            url: '@Url.Content("getProductList")',
            success: function (result) {
                populateStdDropdown(result, "mySearch", "Chọn sản phẩm");
                $.ajax({
                    type:"POST",
                    dataType:'json',
                    url:'@Url.Content("getThanhVienList")',
                    success: function (result) {
                        populateStdDropdown(result, "mySearch2", "Chọn thành viên");
                    }
                })
            }
        })
        //populateStdDropdown();
    })
    $("#btn-add-1").click(function () {
        var id = $("#mySearch2").val();
        var thanhtoan = $("#check-box-tt").is(":checked");
        var giaohang = $("#check-box-gh").is(":checked");
      
        if (id.toString().trim().length == 0) {
            alert("Vui lòng chọn Khách hàng thành viên");
        }
        $.ajax({
            type: "POST",
            data: { MaKH: id, IsThanhToan: thanhtoan, IsGiaoHang: giaohang },
            url:'@Url.Content("DatHang")',
            success: function (result) {
                alert(result);
                location.reload();
            }
        })
    })
    //$("#mySearch2").change(function () {
    //    var id = $("#mySearch2").val();
    //    //alert(id);
    //})
    $("#btn-add-product").click(function () {
        var id = $("#mySearch").val();
        var quantity = $("#product-number").val();
     
        $.ajax({
            type: "POST",
            data: { MaSP: id, SoLuong: quantity },
            url:'@Url.Content("addNewProduct")',
            success: function (result) {
                //alert(result);
                if(result.includes("alert")){
                    alert("Hết hàng. Không thể đặt thêm!!!");
                }
                else {
                    //var tmp = result.substring(0, indexOf("<div>"));
                    //alert(tmp);
                    $("#row_holder").html(result);
                }
            },
        })
    })
    // from a list item.Key & item.Value
    function genDropdownOption(data) {
        var rows = '';
        $.each(data, function (i, item) {
            rows += '<option value="' + item.Key + '">' + item.Value + '</option>';
        });
        return rows;
    }

    function populateStdDropdown(data, id, string) {
        id = '#' + id;
        var rows = '<option value="">'+string+'</option>'
            + genDropdownOption(data);

        $(id).html(rows);
        $(id).selectpicker('refresh');
        
    }
 
</script>
